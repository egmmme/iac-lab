name: Terraform + Ansible CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  RESOURCE_GROUP: rg-terraform-ansible-demo
  VM_NAME: vm-demo
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  TF_STATE_RG: ${{ secrets.TF_STATE_RG }}
  TF_STATE_STORAGE: ${{ secrets.TF_STATE_STORAGE }}
  TF_STATE_CONTAINER: ${{ secrets.TF_STATE_CONTAINER }}
  TF_STATE_KEY: ${{ secrets.TF_STATE_KEY }}

jobs:
  # ================================================================
  # LEVEL 1: MODULE UNIT TESTS
  # ================================================================
  terraform-lint:
    name: üìã Terraform - Syntax & Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

      - name: TFLint Init
        run: tflint --init

      - name: Run TFLint
        run: tflint --recursive

      - name: Install tfsec
        run: |
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

      - name: Run tfsec (Security Scan)
        run: |
          echo "üõ°Ô∏è Running tfsec (Security Scan)..."
          tfsec . --soft-fail || echo "‚ö†Ô∏è Vulnerabilities found (non-blocking in Level 1)"
        continue-on-error: true

  ansible-lint:
    name: üìã Ansible - Syntax & Best Practices
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible and ansible-lint
        run: |
          pip install ansible ansible-lint

      - name: Run ansible-lint
        run: ansible-lint -c .ansible-lint.yml setup_vm.yml

  # ================================================================
  # LEVEL 2: INTEGRATION TESTS
  # ================================================================
  security-scan:
    name: üîó Security Scan - tfsec (strict)
    runs-on: ubuntu-latest
    needs: [terraform-lint, ansible-lint]
    steps:
      - uses: actions/checkout@v4

      - name: Install tfsec
        run: |
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

      - name: Run tfsec (strict mode)
        run: |
          echo "üõ°Ô∏è Running tfsec in strict mode..."
          tfsec . --format default --config-file .tfsec/config.yml

  terratest-modules:
    name: üîó Terratest - Modules
    runs-on: ubuntu-latest
    needs: [terraform-lint, ansible-lint]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
          cache-dependency-path: tests/go.sum

      - name: Azure Login
        run: |
          az login --service-principal \
            -u ${{ secrets.AZURE_CLIENT_ID }} \
            -p ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run Terratest
        working-directory: ./tests
        run: |
          go mod download
          go test -v -timeout 30m

  # ================================================================
  # LEVEL 3: E2E DEPLOY & SMOKE TESTS
  # ================================================================
  deploy-infrastructure:
    name: üöÄ Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [security-scan, terratest-modules]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      vm_public_ip: ${{ steps.terraform-output.outputs.vm_public_ip }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Azure Login
        run: |
          az login --service-principal \
            -u ${{ secrets.AZURE_CLIENT_ID }} \
            -p ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Generate SSH Keys
        run: ./.github/scripts/ssh/setup-keys.sh

      - name: Terraform Init
        run: ./.github/scripts/terraform/init.sh

      - name: Import Existing Resources (if pre-created)
        run: ./.github/scripts/terraform/import-resources.sh

      - name: Terraform Plan
        run: |
          terraform plan \
            -var="admin_username=azureuser" \
            -var="ssh_public_key=$(cat ~/.ssh/id_rsa.pub)" \
            -out=tfplan

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

      - name: Get Terraform Outputs
        id: terraform-output
        run: |
          VM_IP=$(terraform output -raw vm_public_ip)
          echo "vm_public_ip=$VM_IP" >> $GITHUB_OUTPUT
          echo "VM_PUBLIC_IP=$VM_IP" >> $GITHUB_ENV

      - name: Upload SSH Keys
        uses: actions/upload-artifact@v4
        with:
          name: ssh-keys
          path: |
            ~/.ssh/id_rsa
            ~/.ssh/id_rsa.pub
          retention-days: 1

  configure-services:
    name: üéØ Configure with Ansible
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Download SSH Keys
        uses: actions/download-artifact@v4
        with:
          name: ssh-keys
          path: /tmp/ssh-keys/

      - name: Set SSH Permissions
        run: ./.github/scripts/ssh/restore-keys.sh /tmp/ssh-keys

      - name: Create Ansible Inventory
        env:
          VM_IP: ${{ needs.deploy-infrastructure.outputs.vm_public_ip }}
        run: ./.github/scripts/ansible/create-inventory.sh

      - name: Wait for SSH
        env:
          VM_IP: ${{ needs.deploy-infrastructure.outputs.vm_public_ip }}
        run: ./.github/scripts/ansible/wait-for-ssh.sh

      - name: Run Ansible Playbook
        run: ansible-playbook -i inventory.ini setup_vm.yml -v

  smoke-tests:
    name: üß™ Smoke Tests E2E
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, configure-services]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Test HTTP Status
        env:
          VM_IP: ${{ needs.deploy-infrastructure.outputs.vm_public_ip }}
        run: ./.github/scripts/testing/smoke-tests.sh

  # ================================================================
  # CLEANUP: Destroy resources after tests
  # ================================================================
  cleanup:
    name: üßπ Cleanup - Destroy Resources
    runs-on: ubuntu-latest
    needs: [smoke-tests]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Azure Login
        run: |
          az login --service-principal \
            -u ${{ secrets.AZURE_CLIENT_ID }} \
            -p ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init
        run: ./.github/scripts/terraform/init.sh

      - name: Terraform Destroy
        run: |
          echo "üßπ Destroying demo resources..."
          terraform destroy -auto-approve \
            -var="admin_username=azureuser" \
            -var="ssh_public_key=ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDummy" || true

      - name: Verify Cleanup
        run: |
          echo "üîç Verifying cleanup..."
          REMAINING=$(az resource list -g ${{ env.RESOURCE_GROUP }} --query "length(@)" -o tsv 2>/dev/null || echo "0")
          if [ "$REMAINING" = "0" ]; then
            echo "‚úÖ All resources deleted"
          else
            echo "‚ö†Ô∏è Still $REMAINING resources remaining (manual cleanup may be needed)"
          fi
