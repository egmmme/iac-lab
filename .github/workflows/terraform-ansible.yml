name: Terraform + Ansible CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  RESOURCE_GROUP: rg-terraform-ansible-demo
  VM_NAME: vm-demo
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  TF_STATE_RG: ${{ secrets.TF_STATE_RG }}
  TF_STATE_STORAGE: ${{ secrets.TF_STATE_STORAGE }}
  TF_STATE_CONTAINER: ${{ secrets.TF_STATE_CONTAINER }}
  TF_STATE_KEY: ${{ secrets.TF_STATE_KEY }}

jobs:
  # ================================================================
  # LEVEL 1: MODULE UNIT TESTS
  # ================================================================
  terraform-lint:
    name: üìã Terraform - Syntax & Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

      - name: TFLint Init
        run: tflint --init

      - name: Run TFLint
        run: tflint --recursive

      - name: Install tfsec
        run: |
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

      - name: Run tfsec (Security Scan)
        run: |
          echo "üõ°Ô∏è Running tfsec (Security Scan)..."
          tfsec . --soft-fail || echo "‚ö†Ô∏è Vulnerabilities found (non-blocking in Level 1)"
        continue-on-error: true

  ansible-lint:
    name: üìã Ansible - Syntax & Best Practices
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible and ansible-lint
        run: |
          pip install ansible ansible-lint

      - name: Run ansible-lint
        run: ansible-lint -c .ansible-lint.yml setup_vm.yml

  # ================================================================
  # LEVEL 2: INTEGRATION TESTS
  # ================================================================
  security-scan:
    name: üîó Security Scan - tfsec (strict)
    runs-on: ubuntu-latest
    needs: [terraform-lint, ansible-lint]
    steps:
      - uses: actions/checkout@v4

      - name: Install tfsec
        run: |
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash

      - name: Run tfsec (strict mode)
        run: |
          echo "üõ°Ô∏è Running tfsec in strict mode..."
          tfsec . --format default --config-file .tfsec/config.yml

  terratest-modules:
    name: üîó Terratest - Modules
    runs-on: ubuntu-latest
    needs: [terraform-lint, ansible-lint]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
          cache-dependency-path: tests/go.sum

      - name: Azure Login
        run: |
          az login --service-principal \
            -u ${{ secrets.AZURE_CLIENT_ID }} \
            -p ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run Terratest
        working-directory: ./tests
        run: |
          go mod download
          go test -v -timeout 30m

  # ================================================================
  # LEVEL 3: E2E DEPLOY & SMOKE TESTS
  # ================================================================
  deploy-infrastructure:
    name: üöÄ Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [security-scan, terratest-modules]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      vm_public_ip: ${{ steps.terraform-output.outputs.vm_public_ip }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Azure Login
        run: |
          az login --service-principal \
            -u ${{ secrets.AZURE_CLIENT_ID }} \
            -p ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Generate SSH Keys
        run: |
          mkdir -p ~/.ssh
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
          chmod 600 ~/.ssh/id_rsa
          chmod 644 ~/.ssh/id_rsa.pub

      - name: Terraform Init
        run: |
          echo "üîê Ensure remote state resources (idempotent)"
          az group create -n $TF_STATE_RG -l "West Europe" --tags managedBy=terraform || true
          az storage account create --name $TF_STATE_STORAGE --resource-group $TF_STATE_RG --location "West Europe" --sku Standard_LRS --kind StorageV2 --allow-blob-public-access false || true
          az storage container create --name $TF_STATE_CONTAINER --account-name $TF_STATE_STORAGE --auth-mode login || true

          echo "üì¶ terraform init with remote backend"
          terraform init \
            -backend-config="resource_group_name=$TF_STATE_RG" \
            -backend-config="storage_account_name=$TF_STATE_STORAGE" \
            -backend-config="container_name=$TF_STATE_CONTAINER" \
            -backend-config="key=$TF_STATE_KEY"

      - name: Import Existing Resources (if pre-created)
        run: |
          echo "üîç Checking current state..."
          terraform state list || echo "State is empty"

          # Import Resource Group
          if ! terraform state list 2>/dev/null | grep -q "azurerm_resource_group.demo"; then
            if az group show -n $RESOURCE_GROUP >/dev/null 2>&1; then
              echo "‚û°Ô∏è Importing Resource Group: $RESOURCE_GROUP"
              terraform import \
                -var="admin_username=azureuser" \
                -var="ssh_public_key=$(cat ~/.ssh/id_rsa.pub)" \
                azurerm_resource_group.demo \
                "/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP" || echo "‚ö†Ô∏è RG import failed or already exists"
            fi
          else
            echo "‚úÖ Resource Group already in state"
          fi

          # Import VNet
          if ! terraform state list 2>/dev/null | grep -q "module.network.azurerm_virtual_network.main"; then
            VNET_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Network/virtualNetworks/vnet-demo"
            if az network vnet show --ids "$VNET_ID" >/dev/null 2>&1; then
              echo "‚û°Ô∏è Importing VNet: vnet-demo"
              terraform import \
                -var="admin_username=azureuser" \
                -var="ssh_public_key=$(cat ~/.ssh/id_rsa.pub)" \
                module.network.azurerm_virtual_network.main \
                "$VNET_ID" || echo "‚ö†Ô∏è VNet import failed"
            fi
          else
            echo "‚úÖ VNet already in state"
          fi

          # Import Subnet
          if ! terraform state list 2>/dev/null | grep -q "module.network.azurerm_subnet.main"; then
            SUBNET_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Network/virtualNetworks/vnet-demo/subnets/subnet-demo"
            if az network vnet subnet show --ids "$SUBNET_ID" >/dev/null 2>&1; then
              echo "‚û°Ô∏è Importing Subnet: subnet-demo"
              terraform import \
                -var="admin_username=azureuser" \
                -var="ssh_public_key=$(cat ~/.ssh/id_rsa.pub)" \
                module.network.azurerm_subnet.main \
                "$SUBNET_ID" || echo "‚ö†Ô∏è Subnet import failed"
            fi
          else
            echo "‚úÖ Subnet already in state"
          fi

          # Import Public IP
          if ! terraform state list 2>/dev/null | grep -q "module.network.azurerm_public_ip.main"; then
            PIP_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Network/publicIPAddresses/pip-demo"
            if az network public-ip show --ids "$PIP_ID" >/dev/null 2>&1; then
              echo "‚û°Ô∏è Importing Public IP: pip-demo"
              terraform import \
                -var="admin_username=azureuser" \
                -var="ssh_public_key=$(cat ~/.ssh/id_rsa.pub)" \
                module.network.azurerm_public_ip.main \
                "$PIP_ID" || echo "‚ö†Ô∏è Public IP import failed"
            fi
          else
            echo "‚úÖ Public IP already in state"
          fi

          # Import NSG
          if ! terraform state list 2>/dev/null | grep -q "module.security.azurerm_network_security_group.main"; then
            NSG_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Network/networkSecurityGroups/nsg-demo"
            if az network nsg show --ids "$NSG_ID" >/dev/null 2>&1; then
              echo "‚û°Ô∏è Importing NSG: nsg-demo"
              terraform import \
                -var="admin_username=azureuser" \
                -var="ssh_public_key=$(cat ~/.ssh/id_rsa.pub)" \
                module.security.azurerm_network_security_group.main \
                "$NSG_ID" || echo "‚ö†Ô∏è NSG import failed"
            fi
          else
            echo "‚úÖ NSG already in state"
          fi

          # Import NSG Rules
          if ! terraform state list 2>/dev/null | grep -q 'module.security.azurerm_network_security_rule.rules\["AllowSSH"\]'; then
            SSH_RULE_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Network/networkSecurityGroups/nsg-demo/securityRules/AllowSSH"
            if az network nsg rule show --ids "$SSH_RULE_ID" >/dev/null 2>&1; then
              echo "‚û°Ô∏è Importing SSH Rule"
              terraform import \
                -var="admin_username=azureuser" \
                -var="ssh_public_key=$(cat ~/.ssh/id_rsa.pub)" \
                'module.security.azurerm_network_security_rule.rules["AllowSSH"]' \
                "$SSH_RULE_ID" || echo "‚ö†Ô∏è SSH rule import failed"
            fi
          fi

          if ! terraform state list 2>/dev/null | grep -q 'module.security.azurerm_network_security_rule.rules\["AllowHTTP"\]'; then
            HTTP_RULE_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Network/networkSecurityGroups/nsg-demo/securityRules/AllowHTTP"
            if az network nsg rule show --ids "$HTTP_RULE_ID" >/dev/null 2>&1; then
              echo "‚û°Ô∏è Importing HTTP Rule"
              terraform import \
                -var="admin_username=azureuser" \
                -var="ssh_public_key=$(cat ~/.ssh/id_rsa.pub)" \
                'module.security.azurerm_network_security_rule.rules["AllowHTTP"]' \
                "$HTTP_RULE_ID" || echo "‚ö†Ô∏è HTTP rule import failed"
            fi
          fi

          # Import Network Interface
          if ! terraform state list 2>/dev/null | grep -q "module.compute.azurerm_network_interface.main"; then
            NIC_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Network/networkInterfaces/nic-demo"
            if az network nic show --ids "$NIC_ID" >/dev/null 2>&1; then
              echo "‚û°Ô∏è Importing Network Interface: nic-demo"
              terraform import \
                -var="admin_username=azureuser" \
                -var="ssh_public_key=$(cat ~/.ssh/id_rsa.pub)" \
                module.compute.azurerm_network_interface.main \
                "$NIC_ID" || echo "‚ö†Ô∏è NIC import failed"
            fi
          else
            echo "‚úÖ NIC already in state"
          fi

          # Import NIC-NSG Association
          if ! terraform state list 2>/dev/null | grep -q "module.compute.azurerm_network_interface_security_group_association.main"; then
            NIC_NSG_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Network/networkInterfaces/nic-demo|/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Network/networkSecurityGroups/nsg-demo"
            if az network nic show --ids "/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Network/networkInterfaces/nic-demo" >/dev/null 2>&1; then
              echo "‚û°Ô∏è Importing NIC-NSG Association"
              terraform import \
                -var="admin_username=azureuser" \
                -var="ssh_public_key=$(cat ~/.ssh/id_rsa.pub)" \
                module.compute.azurerm_network_interface_security_group_association.main \
                "$NIC_NSG_ID" || echo "‚ö†Ô∏è NIC-NSG association import failed"
            fi
          else
            echo "‚úÖ NIC-NSG association already in state"
          fi

          # Import Virtual Machine
          if ! terraform state list 2>/dev/null | grep -q "module.compute.azurerm_linux_virtual_machine.main"; then
            VM_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Compute/virtualMachines/vm-demo"
            if az vm show --ids "$VM_ID" >/dev/null 2>&1; then
              echo "‚û°Ô∏è Importing Virtual Machine: vm-demo"
              terraform import \
                -var="admin_username=azureuser" \
                -var="ssh_public_key=$(cat ~/.ssh/id_rsa.pub)" \
                module.compute.azurerm_linux_virtual_machine.main \
                "$VM_ID" || echo "‚ö†Ô∏è VM import failed"
            fi
          else
            echo "‚úÖ VM already in state"
          fi

          echo ""
          echo "üìã Final state list:"
          terraform state list || echo "No resources in state"

      - name: Terraform Plan
        run: |
          terraform plan \
            -var="admin_username=azureuser" \
            -var="ssh_public_key=$(cat ~/.ssh/id_rsa.pub)" \
            -out=tfplan

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

      - name: Get Terraform Outputs
        id: terraform-output
        run: |
          VM_IP=$(terraform output -raw vm_public_ip)
          echo "vm_public_ip=$VM_IP" >> $GITHUB_OUTPUT
          echo "VM_PUBLIC_IP=$VM_IP" >> $GITHUB_ENV

      - name: Upload SSH Keys
        uses: actions/upload-artifact@v4
        with:
          name: ssh-keys
          path: |
            ~/.ssh/id_rsa
            ~/.ssh/id_rsa.pub
          retention-days: 1

  configure-services:
    name: üéØ Configure with Ansible
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Download SSH Keys
        uses: actions/download-artifact@v4
        with:
          name: ssh-keys
          path: /tmp/ssh-keys/

      - name: Set SSH Permissions
        run: |
          mkdir -p ~/.ssh
          cp /tmp/ssh-keys/id_rsa ~/.ssh/id_rsa
          cp /tmp/ssh-keys/id_rsa.pub ~/.ssh/id_rsa.pub
          chmod 600 ~/.ssh/id_rsa
          chmod 644 ~/.ssh/id_rsa.pub

      - name: Create Ansible Inventory
        env:
          VM_IP: ${{ needs.deploy-infrastructure.outputs.vm_public_ip }}
        run: |
          echo "[webservers]" > inventory.ini
          echo "$VM_IP ansible_user=azureuser ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_ssh_common_args='-o StrictHostKeyChecking=no'" >> inventory.ini

      - name: Wait for SSH
        env:
          VM_IP: ${{ needs.deploy-infrastructure.outputs.vm_public_ip }}
        run: |
          echo "‚è≥ Waiting for VM to be ready..."
          sleep 60
          MAX_RETRIES=30
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes -i ~/.ssh/id_rsa azureuser@$VM_IP "echo 'SSH OK'" 2>/dev/null; then
              echo "‚úÖ SSH available!"
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            [ $RETRY_COUNT -lt $MAX_RETRIES ] && sleep 10
          done
          if [ "$RETRY_COUNT" -eq "$MAX_RETRIES" ]; then
            echo "‚ùå Could not establish SSH connection after $MAX_RETRIES attempts"
            exit 1
          fi

      - name: Run Ansible Playbook
        run: ansible-playbook -i inventory.ini setup_vm.yml -v

  smoke-tests:
    name: üß™ Smoke Tests E2E
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, configure-services]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Test HTTP Status
        env:
          VM_IP: ${{ needs.deploy-infrastructure.outputs.vm_public_ip }}
        run: |
          echo "üß™ === SMOKE TESTS E2E ==="
          echo "Target: http://$VM_IP"

          # Test 1: HTTP Status 200
          echo "Test 1: Verify HTTP 200..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$VM_IP)
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ HTTP 200 OK"
          else
            echo "‚ùå HTTP $HTTP_STATUS - Expected 200"
            exit 1
          fi

          # Test 2: Nginx Header
          echo "Test 2: Verify Nginx header..."
          if curl -sI http://$VM_IP | grep -i "nginx"; then
            echo "‚úÖ Nginx header present"
          else
            echo "‚ùå Nginx header not found"
            exit 1
          fi

          # Test 3: Content Check
          echo "Test 3: Verify content..."
          if curl -s http://$VM_IP | grep -i "Welcome"; then
            echo "‚úÖ Content correct"
          else
            echo "‚ùå Content not found"
            exit 1
          fi

          echo "‚úÖ === ALL SMOKE TESTS PASSED ==="

  # ================================================================
  # CLEANUP: Destroy resources after tests
  # ================================================================
  cleanup:
    name: üßπ Cleanup - Destroy Resources
    runs-on: ubuntu-latest
    needs: [smoke-tests]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Azure Login
        run: |
          az login --service-principal \
            -u ${{ secrets.AZURE_CLIENT_ID }} \
            -p ${{ secrets.AZURE_CLIENT_SECRET }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }}
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init
        run: |
          echo "üì¶ terraform init with remote backend for cleanup"
          terraform init \
            -backend-config="resource_group_name=$TF_STATE_RG" \
            -backend-config="storage_account_name=$TF_STATE_STORAGE" \
            -backend-config="container_name=$TF_STATE_CONTAINER" \
            -backend-config="key=$TF_STATE_KEY"

      - name: Terraform Destroy
        run: |
          echo "üßπ Destroying demo resources..."
          terraform destroy -auto-approve \
            -var="admin_username=azureuser" \
            -var="ssh_public_key=ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDummy" || true

      - name: Verify Cleanup
        run: |
          echo "üîç Verifying cleanup..."
          REMAINING=$(az resource list -g ${{ env.RESOURCE_GROUP }} --query "length(@)" -o tsv 2>/dev/null || echo "0")
          if [ "$REMAINING" = "0" ]; then
            echo "‚úÖ All resources deleted"
          else
            echo "‚ö†Ô∏è Still $REMAINING resources remaining (manual cleanup may be needed)"
          fi
