# ===================================================================
# Azure DevOps Pipeline - Terraform + Ansible Demo
# ===================================================================
# Prop√≥sito: Demostrar integraci√≥n de Terraform (infraestructura)
#            y Ansible (configuraci√≥n) en un pipeline CI/CD
# ===================================================================

trigger:
  - main

pool:
  vmImage: "ubuntu-latest"

variables:
  RESOURCE_GROUP: "rg-terraform-ansible-demo"
  VM_NAME: "vm-demo"

stages:
  # ================================================================
  # STAGE 0: LINT & TEST - Validaci√≥n, Linting y Testing IaC
  # ================================================================
  - stage: LintAndTest
    displayName: "üß™ Lint & Test - IaC"
    jobs:
      - job: TerraformLint
        displayName: "Terraform - fmt/validate/tflint/tfsec"
        steps:
          - script: |
              wget -q https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
              unzip -o terraform_1.6.0_linux_amd64.zip
              sudo mv terraform /usr/local/bin/
              terraform --version
            displayName: "üì¶ Instalar Terraform"
          - script: |
              curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
              tflint --version
            displayName: "üì¶ Instalar TFLint"
          - script: |
              # Inicializar plugins (azurerm ruleset)
              tflint --init
            displayName: "üîß TFLint init (plugins)"
          - script: |
              curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
              tfsec --version
            displayName: "üì¶ Instalar tfsec"
          - script: |
              terraform init -backend=false
              terraform fmt -check -recursive
              terraform validate
            displayName: "‚úÖ Terraform validate + fmt"
          - script: |
              tflint --recursive
            displayName: "üîç TFLint (Terraform Lint)"
          - script: |
              tfsec .
            displayName: "üõ°Ô∏è tfsec (Security Scan)"

      - job: AnsibleLint
        displayName: "Ansible - ansible-lint"
        steps:
          - script: |
              sudo apt-get update
              sudo apt-get install -y python3-pip
              pip3 install --user ansible ansible-lint
              ~/.local/bin/ansible-lint --version
            displayName: "üì¶ Instalar ansible-lint"
          - script: |
              ~/.local/bin/ansible-lint -c .ansible-lint.yml setup_vm.yml
            displayName: "üîç Ejecutar ansible-lint"

      - job: Terratest
        displayName: "Terratest - plan de m√≥dulos y root"
        steps:
          - script: |
              sudo apt-get update
              sudo apt-get install -y golang-go
              go version
            displayName: "üì¶ Instalar Go"
          - script: |
              wget -q https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
              unzip -o terraform_1.6.0_linux_amd64.zip
              sudo mv terraform /usr/local/bin/
            displayName: "üì¶ Instalar Terraform"
          - script: |
              az login --service-principal \
                -u $(azureServicePrincipalUsername) \
                -p $(azureServicePrincipalPassword) \
                --tenant $(azureTenant)
              export ARM_CLIENT_ID=$(azureServicePrincipalUsername)
              export ARM_CLIENT_SECRET=$(azureServicePrincipalPassword)
              export ARM_TENANT_ID=$(azureTenant)
              export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
              cd tests
              go env -w GOPATH=$HOME/go
              go mod tidy
              go mod download
              go test -v -timeout 30m ./...
            displayName: "üß™ Ejecutar Terratest (plan)"
  # ================================================================
  # STAGE 1: TERRAFORM - Provisionar Infraestructura
  # ================================================================
  - stage: Provision
    displayName: "üèóÔ∏è Terraform - Crear Infraestructura"
    dependsOn: LintAndTest
    jobs:
      - job: TerraformApply
        displayName: "Terraform Apply"
        steps:
          # Instalar Terraform
          - script: |
              wget -q https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
              unzip -o terraform_1.6.0_linux_amd64.zip
              sudo mv terraform /usr/local/bin/
              terraform --version
            displayName: "üì¶ Instalar Terraform"

          # Generar claves SSH
          - script: |
              ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
              echo "Clave SSH generada:"
              cat ~/.ssh/id_rsa.pub
              # Guardar clave privada como artefacto seguro
              mkdir -p $(Build.ArtifactStagingDirectory)/ssh
              cp ~/.ssh/id_rsa $(Build.ArtifactStagingDirectory)/ssh/id_rsa
              cp ~/.ssh/id_rsa.pub $(Build.ArtifactStagingDirectory)/ssh/id_rsa.pub
            displayName: "üîë Generar claves SSH"

          # Publicar claves SSH como artefacto
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: "$(Build.ArtifactStagingDirectory)/ssh"
              artifact: "sshkeys"
              publishLocation: "pipeline"
            displayName: "üì§ Publicar claves SSH"

          # Ejecutar Terraform
          - script: |
              set -e

              # Login a Azure
              az login --service-principal \
                -u $(azureServicePrincipalUsername) \
                -p $(azureServicePrincipalPassword) \
                --tenant $(azureTenant)

              # Variables de entorno para Terraform
              export ARM_CLIENT_ID=$(azureServicePrincipalUsername)
              export ARM_CLIENT_SECRET=$(azureServicePrincipalPassword)
              export ARM_TENANT_ID=$(azureTenant)
              export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

              # Limpiar recursos existentes
              echo "üßπ Limpiando recursos existentes..."
              if az group show --name $(RESOURCE_GROUP) &>/dev/null; then
                az group delete --name $(RESOURCE_GROUP) --yes
              fi

              # Obtener clave SSH p√∫blica
              SSH_PUB_KEY=$(cat ~/.ssh/id_rsa.pub)

              # Terraform init, validate y apply
              terraform init
              terraform fmt -check -recursive || echo "‚ö†Ô∏è Archivos no formateados (no bloqueante)"
              terraform validate
              terraform plan -out=tfplan -var="ssh_public_key=$SSH_PUB_KEY"
              terraform apply -auto-approve tfplan

              # Capturar IP de la VM
              VM_IP=$(terraform output -raw vm_public_ip)
              echo "‚úÖ VM creada con IP: $VM_IP"
              echo "##vso[task.setvariable variable=VM_PUBLIC_IP;isOutput=true]$VM_IP"
            displayName: "üöÄ Terraform Apply"
            name: terraformOutput

  # ================================================================
  # STAGE 2: ANSIBLE - Configurar Software
  # ================================================================
  - stage: Configure
    displayName: "‚öôÔ∏è Ansible - Configurar VM"
    dependsOn: Provision
    jobs:
      - job: AnsibleConfigure
        displayName: "Ansible Playbook"
        variables:
          vmIP: $[ stageDependencies.Provision.TerraformApply.outputs['terraformOutput.VM_PUBLIC_IP'] ]
        steps:
          # Instalar Ansible
          - script: |
              sudo apt-get update
              sudo apt-get install -y ansible
              ansible --version
            displayName: "üì¶ Instalar Ansible"
          # Descargar claves SSH del stage anterior
          - task: DownloadPipelineArtifact@2
            displayName: "üì• Descargar claves SSH"
            inputs:
              artifactName: "sshkeys"
              targetPath: "$(Pipeline.Workspace)/sshkeys"
          # Restaurar claves SSH
          - script: |
              mkdir -p ~/.ssh
              cp $(Pipeline.Workspace)/sshkeys/id_rsa ~/.ssh/id_rsa
              cp $(Pipeline.Workspace)/sshkeys/id_rsa.pub ~/.ssh/id_rsa.pub
              chmod 600 ~/.ssh/id_rsa
              chmod 644 ~/.ssh/id_rsa.pub
              echo "Clave SSH restaurada:"
              ssh-keygen -lf ~/.ssh/id_rsa.pub
            displayName: "üîë Restaurar claves SSH"

          # Generar inventario din√°mico
          - script: |
              echo "üìù Generando inventario Ansible..."
              echo "[webservers]" > inventory.ini
              echo "$(vmIP) ansible_user=azureuser ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_ssh_common_args='-o StrictHostKeyChecking=no'" >> inventory.ini

              echo "Inventario generado:"
              cat inventory.ini
            displayName: "üìã Crear inventario"

          # Esperar a que la VM est√© completamente lista
          - script: |
              echo "‚è≥ Esperando a que la VM est√© lista..."
              echo "IP de la VM: $(vmIP)"

              # Esperar inicial para cloud-init
              echo "Esperando 60 segundos para inicializaci√≥n de la VM..."
              sleep 60

              MAX_RETRIES=30
              RETRY_COUNT=0

              while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                echo "Intento SSH $((RETRY_COUNT + 1))/$MAX_RETRIES..."
                if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes -i ~/.ssh/id_rsa azureuser@$(vmIP) "echo 'SSH OK'" 2>/dev/null; then
                  echo "‚úÖ SSH disponible!"
                  # Verificar que cloud-init termin√≥
                  ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa azureuser@$(vmIP) "cloud-init status --wait" 2>/dev/null || echo "Cloud-init check skipped"
                  break
                fi
                RETRY_COUNT=$((RETRY_COUNT + 1))
                [ $RETRY_COUNT -lt $MAX_RETRIES ] && sleep 10
              done

              if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                echo "‚ùå ERROR: No se pudo conectar por SSH despu√©s de $((MAX_RETRIES * 10)) segundos"
                echo "Troubleshooting: verifique NSG rules, VM status, y SSH key en Azure Portal"
                exit 1
              fi
            displayName: "üîå Esperar conexi√≥n SSH"

          # Ejecutar Ansible Playbook
          - script: |
              echo "üé≠ Ejecutando Ansible playbook..."
              ansible-playbook -i inventory.ini setup_vm.yml -v
            displayName: "üéØ Ansible Playbook"

          # Verificar resultado
          - script: |
              echo "üåê Verificando deployment..."
              echo "Puedes acceder a: http://$(vmIP)"

              # Test HTTP
              sleep 5
              curl -s http://$(vmIP) | grep -q "Terraform + Ansible" && echo "‚úÖ Nginx OK" || echo "‚ö†Ô∏è Nginx podr√≠a no estar listo a√∫n"
            displayName: "‚úîÔ∏è Verificar deployment"
# ===================================================================
# NOTAS DE CONFIGURACI√ìN:
#
# 1. Crear variables secretas en Azure DevOps:
#    - azureServicePrincipalUsername (App ID)
#    - azureServicePrincipalPassword (Client Secret)
#    - azureTenant (Tenant ID)
#
# 2. Para crear Service Principal:
#    az ad sp create-for-rbac --name "terraform-ansible-demo" \
#      --role Contributor \
#      --scopes /subscriptions/{SUBSCRIPTION_ID}
#
# 3. Costo aproximado: Standard_B1s ‚âà $8-10/mes
#    Eliminar recursos: az group delete --name rg-terraform-ansible-demo --yes
# ===================================================================
