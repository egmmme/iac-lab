# ===================================================================
# Azure DevOps Pipeline - Terraform + Ansible con Matriz de Pruebas IaC
# ===================================================================
# MATRIZ DE PRUEBAS:
# - Nivel 1 (Unitarias): Sintaxis, linting, seguridad
# - Nivel 2 (Integraci√≥n): Plan completo, validaci√≥n de m√≥dulos
# - Nivel 3 (E2E): Deploy + Smoke tests
# ===================================================================

trigger:
  - main

pool:
  vmImage: "ubuntu-latest"

variables:
  RESOURCE_GROUP: "rg-terraform-ansible-demo"
  VM_NAME: "vm-demo"

stages:
  # ================================================================
  # NIVEL 1: PRUEBAS UNITARIAS DE M√ìDULO
  # Criterio entrada: C√≥digo IaC modificado (commit/PR)
  # Criterio salida: Sintaxis v√°lida, linting OK, sin vulnerabilidades
  # ================================================================
  - stage: UnitTests
    displayName: "üìã Nivel 1: Pruebas Unitarias"
    jobs:
      - job: TerraformLint
        displayName: "Terraform - Sintaxis y Seguridad"
        steps:
          - script: |
              wget -q https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
              unzip -o terraform_1.6.0_linux_amd64.zip
              sudo mv terraform /usr/local/bin/
              terraform --version
            displayName: "üì¶ Instalar Terraform"
          - script: |
              curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
              tflint --version
            displayName: "üì¶ Instalar TFLint"
          - script: |
              tflint --init
            displayName: "üîß TFLint init (plugins)"
          - script: |
              curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
              tfsec --version
            displayName: "üì¶ Instalar tfsec"
          - script: |
              terraform init -backend=false
              terraform fmt -check -recursive
              terraform validate
            displayName: "‚úÖ Validar sintaxis Terraform"
          - script: |
              tflint --recursive
            displayName: "üîç TFLint (Terraform Lint)"
          - script: |
              echo "üõ°Ô∏è Ejecutando tfsec (Security Scan)..."
              tfsec . --soft-fail || echo "‚ö†Ô∏è Vulnerabilidades encontradas (no bloqueante en Nivel 1)"
            displayName: "üõ°Ô∏è tfsec (Security Scan - soft-fail)"
            continueOnError: "true"

      - job: AnsibleLint
        displayName: "Ansible - Sintaxis y Best Practices"
        steps:
          - script: |
              sudo apt-get update
              sudo apt-get install -y python3-pip
              pip3 install --user ansible ansible-lint
              ~/.local/bin/ansible-lint --version
            displayName: "üì¶ Instalar ansible-lint"
          - script: |
              ~/.local/bin/ansible-lint -c .ansible-lint.yml setup_vm.yml
            displayName: "üîç Ejecutar ansible-lint"

  # ================================================================
  # NIVEL 2: PRUEBAS DE INTEGRACI√ìN POR STACK
  # Criterio entrada: Pruebas unitarias OK
  # Criterio salida: M√≥dulos integrados, plan v√°lido, outputs correctos
  # ================================================================
  - stage: IntegrationTests
    displayName: "üîó Nivel 2: Integraci√≥n por Stack"
    dependsOn: UnitTests
    condition: succeeded()
    jobs:
      # Security Scan - Escaneo estricto de seguridad (bloquea si falla)
      - job: SecurityScan
        displayName: "Escaneo de Seguridad - tfsec (strict)"
        steps:
          - script: |
              curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
              tfsec --version
            displayName: "üì¶ Instalar tfsec"
          - script: |
              echo "üõ°Ô∏è Ejecutando tfsec en modo estricto..."
              tfsec . --format default --config-file .tfsec/config.yml
              if [ $? -ne 0 ]; then
                echo "‚ùå Vulnerabilidades detectadas despu√©s de aplicar exclusiones de demo/lab"
                echo "Revisar .tfsec/config.yml y README-SECURITY.md"
                exit 1
              fi
              echo "‚úÖ Escaneo de seguridad completado (con exclusiones documentadas para demo/lab)"
            displayName: "üîí tfsec Security Scan (strict mode)"

      # Terratest - Pruebas unitarias de m√≥dulos con plan
      - job: TerratestModules
        displayName: "Terratest - Plan de m√≥dulos individuales"
        dependsOn: SecurityScan
        steps:
          - script: |
              sudo apt-get update
              sudo apt-get install -y golang-go
              go version
            displayName: "üì¶ Instalar Go"
          - script: |
              wget -q https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
              unzip -o terraform_1.6.0_linux_amd64.zip
              sudo mv terraform /usr/local/bin/
            displayName: "üì¶ Instalar Terraform"
          - script: |
              az login --service-principal \
                -u $(azureServicePrincipalUsername) \
                -p $(azureServicePrincipalPassword) \
                --tenant $(azureTenant)
              export ARM_CLIENT_ID=$(azureServicePrincipalUsername)
              export ARM_CLIENT_SECRET=$(azureServicePrincipalPassword)
              export ARM_TENANT_ID=$(azureTenant)
              export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
              cd tests
              go env -w GOPATH=$HOME/go
              go mod tidy
              go mod download
              go test -v -timeout 30m ./...
            displayName: "üß™ Ejecutar Terratest (m√≥dulos)"

      # Plan completo del stack integrado
      - job: StackIntegrationPlan
        displayName: "Plan Stack Completo - Validaci√≥n de integraci√≥n"
        dependsOn: TerratestModules
        steps:
          - script: |
              wget -q https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
              unzip -o terraform_1.6.0_linux_amd64.zip
              sudo mv terraform /usr/local/bin/
            displayName: "üì¶ Instalar Terraform"
          - script: |
              ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
              SSH_PUB_KEY=$(cat ~/.ssh/id_rsa.pub)

              az login --service-principal \
                -u $(azureServicePrincipalUsername) \
                -p $(azureServicePrincipalPassword) \
                --tenant $(azureTenant)

              export ARM_CLIENT_ID=$(azureServicePrincipalUsername)
              export ARM_CLIENT_SECRET=$(azureServicePrincipalPassword)
              export ARM_TENANT_ID=$(azureTenant)
              export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

              terraform init
              terraform plan -out=integration.tfplan -var="ssh_public_key=$SSH_PUB_KEY"

              echo "‚úÖ Plan generado - Validando outputs esperados..."
              terraform show -json integration.tfplan | jq '.planned_values.outputs | keys'
            displayName: "üìä Generar Plan de Integraci√≥n"
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: "integration.tfplan"
              artifact: "terraform-plan"
              publishLocation: "pipeline"
            displayName: "üì§ Publicar Plan"

      # Cleanup de recursos de prueba
      - job: CleanupIntegrationResources
        displayName: "üßπ Cleanup recursos de integraci√≥n"
        dependsOn:
          - TerratestModules
          - StackIntegrationPlan
        condition: always()
        steps:
          - script: |
              set -e
              az login --service-principal \
                -u $(azureServicePrincipalUsername) \
                -p $(azureServicePrincipalPassword) \
                --tenant $(azureTenant)

              export ARM_CLIENT_ID=$(azureServicePrincipalUsername)
              export ARM_CLIENT_SECRET=$(azureServicePrincipalPassword)
              export ARM_TENANT_ID=$(azureTenant)
              export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

              echo "üßπ Limpiando recursos de integraci√≥n..."
              TEST_RGS=$(az group list --query "[?starts_with(name, 'terratest-')].name" -o tsv)

              if [ -n "$TEST_RGS" ]; then
                for rg in $TEST_RGS; do
                  echo "üóëÔ∏è Eliminando: $rg"
                  az group delete --name "$rg" --yes --no-wait
                done
              fi
              echo "‚úÖ Limpieza completada"
            displayName: "üóëÔ∏è Destruir recursos de prueba"
            continueOnError: "true"

  # ================================================================
  # NIVEL 3: PRUEBAS E2E POR ENTORNO
  # Criterio entrada: Plan de integraci√≥n aprobado
  # Criterio salida: Infraestructura desplegada, smoke tests OK, servicios funcionando
  # ================================================================
  - stage: E2ETests
    displayName: "üöÄ Nivel 3: E2E - Deploy + Smoke Tests"
    dependsOn: IntegrationTests
    condition: succeeded()
    jobs:
      - job: DeployInfrastructure
        displayName: "Deploy - Infraestructura completa"
        steps:
          - script: |
              wget -q https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
              unzip -o terraform_1.6.0_linux_amd64.zip
              sudo mv terraform /usr/local/bin/
            displayName: "üì¶ Instalar Terraform"
          - script: |
              ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
              mkdir -p $(Build.ArtifactStagingDirectory)/ssh
              cp ~/.ssh/id_rsa $(Build.ArtifactStagingDirectory)/ssh/id_rsa
              cp ~/.ssh/id_rsa.pub $(Build.ArtifactStagingDirectory)/ssh/id_rsa.pub
            displayName: "üîë Generar claves SSH"
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: "$(Build.ArtifactStagingDirectory)/ssh"
              artifact: "sshkeys"
              publishLocation: "pipeline"
            displayName: "üì§ Publicar claves SSH"
          - script: |
              set -e
              az login --service-principal \
                -u $(azureServicePrincipalUsername) \
                -p $(azureServicePrincipalPassword) \
                --tenant $(azureTenant)

              export ARM_CLIENT_ID=$(azureServicePrincipalUsername)
              export ARM_CLIENT_SECRET=$(azureServicePrincipalPassword)
              export ARM_TENANT_ID=$(azureTenant)
              export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

              # Limpiar recursos existentes
              if az group show --name $(RESOURCE_GROUP) &>/dev/null; then
                az group delete --name $(RESOURCE_GROUP) --yes
              fi

              SSH_PUB_KEY=$(cat ~/.ssh/id_rsa.pub)
              terraform init
              terraform plan -out=tfplan -var="ssh_public_key=$SSH_PUB_KEY"
              terraform apply -auto-approve tfplan

              VM_IP=$(terraform output -raw vm_public_ip)
              echo "‚úÖ VM creada con IP: $VM_IP"
              echo "##vso[task.setvariable variable=VM_PUBLIC_IP;isOutput=true]$VM_IP"
            displayName: "üöÄ Terraform Apply"
            name: terraformOutput

      - job: ConfigureServices
        displayName: "Configuraci√≥n - Ansible playbook"
        dependsOn: DeployInfrastructure
        variables:
          vmIP: $[ dependencies.DeployInfrastructure.outputs['terraformOutput.VM_PUBLIC_IP'] ]
        steps:
          - script: |
              sudo apt-get update
              sudo apt-get install -y ansible
            displayName: "üì¶ Instalar Ansible"
          - task: DownloadPipelineArtifact@2
            inputs:
              artifactName: "sshkeys"
              targetPath: "$(Pipeline.Workspace)/sshkeys"
            displayName: "üì• Descargar claves SSH"
          - script: |
              mkdir -p ~/.ssh
              cp $(Pipeline.Workspace)/sshkeys/id_rsa ~/.ssh/id_rsa
              cp $(Pipeline.Workspace)/sshkeys/id_rsa.pub ~/.ssh/id_rsa.pub
              chmod 600 ~/.ssh/id_rsa
              chmod 644 ~/.ssh/id_rsa.pub
            displayName: "üîë Restaurar claves SSH"
          - script: |
              echo "[webservers]" > inventory.ini
              echo "$(vmIP) ansible_user=azureuser ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_ssh_common_args='-o StrictHostKeyChecking=no'" >> inventory.ini
            displayName: "üìã Crear inventario"
          - script: |
              echo "‚è≥ Esperando VM lista..."
              sleep 60
              MAX_RETRIES=30
              RETRY_COUNT=0
              while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes -i ~/.ssh/id_rsa azureuser@$(vmIP) "echo 'SSH OK'" 2>/dev/null; then
                  echo "‚úÖ SSH disponible!"
                  break
                fi
                RETRY_COUNT=$((RETRY_COUNT + 1))
                [ $RETRY_COUNT -lt $MAX_RETRIES ] && sleep 10
              done
              [ $RETRY_COUNT -eq $MAX_RETRIES ] && exit 1
            displayName: "üîå Esperar conexi√≥n SSH"
          - script: |
              ansible-playbook -i inventory.ini setup_vm.yml -v
            displayName: "üéØ Ansible Playbook"

      - job: SmokeTests
        displayName: "Smoke Tests - Validaci√≥n E2E"
        dependsOn:
          - DeployInfrastructure
          - ConfigureServices
        variables:
          vmIP: $[ dependencies.DeployInfrastructure.outputs['terraformOutput.VM_PUBLIC_IP'] ]
        steps:
          - script: |
              echo "üß™ === SMOKE TESTS E2E ==="
              echo "Target: http://$(vmIP)"

              # Test 1: HTTP Status 200
              echo "Test 1: Verificar HTTP 200..."
              HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$(vmIP))
              if [ "$HTTP_STATUS" = "200" ]; then
                echo "‚úÖ HTTP 200 OK"
              else
                echo "‚ùå HTTP $HTTP_STATUS - Expected 200"
                exit 1
              fi

              # Test 2: Contenido esperado
              echo "Test 2: Verificar contenido..."
              RESPONSE=$(curl -s http://$(vmIP))
              if echo "$RESPONSE" | grep -q "Terraform + Ansible"; then
                echo "‚úÖ Contenido correcto"
              else
                echo "‚ùå Contenido no encontrado"
                exit 1
              fi

              # Test 3: Nginx server header
              echo "Test 3: Verificar Nginx headers..."
              if curl -sI http://$(vmIP) | grep -q "nginx"; then
                echo "‚úÖ Nginx header presente"
              else
                echo "‚ö†Ô∏è Nginx header no encontrado (no cr√≠tico)"
              fi

              # Test 4: Response time
              echo "Test 4: Verificar tiempo de respuesta..."
              RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' http://$(vmIP))
              echo "Tiempo de respuesta: ${RESPONSE_TIME}s"

              echo ""
              echo "üéâ ========================================="
              echo "üéâ TODOS LOS SMOKE TESTS PASARON"
              echo "üéâ Aplicaci√≥n desplegada exitosamente"
              echo "üéâ URL: http://$(vmIP)"
              echo "üéâ ========================================="
            displayName: "üîç Ejecutar Smoke Tests"
# ===================================================================
# RESUMEN DE MATRIZ DE PRUEBAS
# ===================================================================
# Fase              | Tests                        | Trigger
# ------------------|------------------------------|------------------
# Nivel 1 (Unit)    | fmt, validate, lint, tfsec   | Cada commit/PR
# Nivel 2 (Integr)  | Terratest plan, Stack plan   | Despu√©s de Nivel 1
# Nivel 3 (E2E)     | Deploy + Smoke tests         | Despu√©s de Nivel 2
#
# Criterios de aprobaci√≥n por nivel:
# - Nivel 1: 100% de validaciones pasan
# - Nivel 2: Plan generado sin errores, m√≥dulos integrados
# - Nivel 3: Deploy exitoso + todos los smoke tests OK
# ===================================================================
