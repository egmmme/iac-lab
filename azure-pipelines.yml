trigger:
  - main

pool:
  vmImage: "ubuntu-latest"

steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: "3.x"

  - script: |
      curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
      sudo apt-get install -y ansible
      curl -sLo terraform.zip https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
      unzip terraform.zip
      sudo mv terraform /usr/local/bin/
    displayName: "Install dependencies"

  - script: |
      # Generate SSH key pair for the VM
      ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
      echo "SSH public key:"
      cat ~/.ssh/id_rsa.pub
    displayName: "Generate SSH Keys"

  - script: |
      set -euo pipefail
      az login --service-principal -u $(azureServicePrincipalUsername) -p $(azureServicePrincipalPassword) --tenant $(azureTenant)
      export ARM_CLIENT_ID=$(azureServicePrincipalUsername)
      export ARM_CLIENT_SECRET=$(azureServicePrincipalPassword)
      export ARM_TENANT_ID=$(azureTenant)
      export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

      # Clean up any existing resource group
      echo "Checking for existing resource group..."
      if az group show --name "lab-resource-group" &>/dev/null; then
        echo "Deleting existing resource group..."
        az group delete --name "lab-resource-group" --yes
        echo "Resource group deleted successfully."
      else
        echo "No existing resource group found."
      fi

      # Get the SSH public key
      SSH_PUB_KEY=$(cat ~/.ssh/id_rsa.pub)

      terraform init

      # Auto region + size fallback selection
      REGIONS=("eastus" "eastus2" "centralus" "southcentralus" "westeurope" "northeurope")
      FALLBACK_SIZES=("Standard_B1ms" "Standard_B2s" "Standard_B1s" "Standard_D2s_v5" "Standard_D2s_v3")
      SELECTED_REGION=""
      SELECTED_SIZE=""
      echo "Attempting region/size selection..."
      for r in "${REGIONS[@]}"; do
        echo "Checking region: $r"
        for sz in "${FALLBACK_SIZES[@]}"; do
          AVAILABLE=$(az vm list-skus -l $r --query "[?name=='$sz' && restrictions==null].name" -o tsv || true)
          if [ "$AVAILABLE" == "$sz" ]; then
            SELECTED_REGION=$r
            SELECTED_SIZE=$sz
            echo "Selected region=$SELECTED_REGION size=$SELECTED_SIZE"
            break
          else
            echo "  Size $sz not available in $r"
          fi
        done
        [ -n "$SELECTED_REGION" ] && break
      done
      if [ -z "$SELECTED_REGION" ] || [ -z "$SELECTED_SIZE" ]; then
        echo "ERROR: Could not find any available VM size in candidate regions" >&2
        exit 1
      fi

      terraform apply -auto-approve -var="ssh_public_key=$SSH_PUB_KEY" -var="location=$SELECTED_REGION" -var="vm_size=$SELECTED_SIZE"

      # Capture the VM public IP from Terraform output
      VM_IP=$(terraform output -raw vm_public_ip || true)
      echo "VM Public IP: $VM_IP"
      echo "##vso[task.setvariable variable=VM_PUBLIC_IP]$VM_IP"

      # Verify VM exists before proceeding
      if ! az vm show --resource-group lab-resource-group --name lab-vm &>/dev/null; then
        echo "ERROR: VM lab-vm not found after terraform apply" >&2
        exit 1
      fi
    displayName: "Terraform Apply"

  - script: |
      # Check if VM IP was captured
      if [ -z "$(VM_PUBLIC_IP)" ]; then
        echo "ERROR: VM Public IP is empty. Terraform output failed."
        exit 1
      fi

      # Update inventory.ini with the actual VM IP
      echo "[azure]" > inventory.ini
      echo "$(VM_PUBLIC_IP) ansible_user=azureuser ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_ssh_common_args='-o StrictHostKeyChecking=no'" >> inventory.ini

      echo "Generated inventory.ini:"
      cat inventory.ini

      # Wait for VM to be ready for SSH with retry logic
      echo "Waiting for VM to be ready for SSH..."
      MAX_RETRIES=20
      RETRY_COUNT=0

      while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
        echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Testing SSH connectivity..."
        if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa azureuser@$(VM_PUBLIC_IP) "echo 'SSH connection successful'" 2>/dev/null; then
          echo "SSH connection established!"
          break
        fi
        RETRY_COUNT=$((RETRY_COUNT + 1))
        if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
          echo "SSH not ready yet, waiting 15 seconds..."
          sleep 15
        fi
      done

      if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
        echo "ERROR: Failed to connect to VM after $MAX_RETRIES attempts"
        echo "Checking VM provisioning state..."
        az vm get-instance-view --resource-group lab-resource-group --name lab-vm --query "instanceView.statuses[?starts_with(code, 'PowerState/')].displayStatus" -o tsv
        exit 1
      fi

      # Run Ansible playbook
      echo "Running Ansible playbook..."
      ansible-playbook -i inventory.ini setup_vm.yml -v
    displayName: "Ansible Playbook"
