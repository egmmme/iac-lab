# ===================================================================
# Azure DevOps Pipeline - Terraform + Ansible Demo
# ===================================================================
# Prop√≥sito: Demostrar integraci√≥n de Terraform (infraestructura)
#            y Ansible (configuraci√≥n) en un pipeline CI/CD
# ===================================================================

trigger:
  - main

pool:
  vmImage: "ubuntu-latest"

variables:
  RESOURCE_GROUP: "rg-terraform-ansible-demo"
  VM_NAME: "vm-demo"

stages:
  # ================================================================
  # STAGE 1: TERRAFORM - Provisionar Infraestructura
  # ================================================================
  - stage: Provision
    displayName: "üèóÔ∏è Terraform - Crear Infraestructura"
    jobs:
      - job: TerraformApply
        displayName: "Terraform Apply"
        steps:
          # Instalar Terraform
          - script: |
              wget -q https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
              unzip -o terraform_1.6.0_linux_amd64.zip
              sudo mv terraform /usr/local/bin/
              terraform --version
            displayName: "üì¶ Instalar Terraform"

          # Generar claves SSH
          - script: |
              ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
              echo "Clave SSH generada:"
              cat ~/.ssh/id_rsa.pub
            displayName: "üîë Generar claves SSH"

          # Ejecutar Terraform
          - script: |
              set -e

              # Login a Azure
              az login --service-principal \
                -u $(azureServicePrincipalUsername) \
                -p $(azureServicePrincipalPassword) \
                --tenant $(azureTenant)

              # Variables de entorno para Terraform
              export ARM_CLIENT_ID=$(azureServicePrincipalUsername)
              export ARM_CLIENT_SECRET=$(azureServicePrincipalPassword)
              export ARM_TENANT_ID=$(azureTenant)
              export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

              # Limpiar recursos existentes
              echo "üßπ Limpiando recursos existentes..."
              if az group show --name $(RESOURCE_GROUP) &>/dev/null; then
                az group delete --name $(RESOURCE_GROUP) --yes
              fi

              # Obtener clave SSH p√∫blica
              SSH_PUB_KEY=$(cat ~/.ssh/id_rsa.pub)

              # Terraform init y apply
              terraform init
              terraform plan -out=tfplan -var="ssh_public_key=$SSH_PUB_KEY"
              terraform apply -auto-approve tfplan

              # Capturar IP de la VM
              VM_IP=$(terraform output -raw vm_public_ip)
              echo "‚úÖ VM creada con IP: $VM_IP"
              echo "##vso[task.setvariable variable=VM_PUBLIC_IP;isOutput=true]$VM_IP"
            displayName: "üöÄ Terraform Apply"
            name: terraformOutput

  # ================================================================
  # STAGE 2: ANSIBLE - Configurar Software
  # ================================================================
  - stage: Configure
    displayName: "‚öôÔ∏è Ansible - Configurar VM"
    dependsOn: Provision
    jobs:
      - job: AnsibleConfigure
        displayName: "Ansible Playbook"
        variables:
          vmIP: $[ stageDependencies.Provision.TerraformApply.outputs['terraformOutput.VM_PUBLIC_IP'] ]
        steps:
          # Instalar Ansible
          - script: |
              sudo apt-get update
              sudo apt-get install -y ansible
              ansible --version
            displayName: "üì¶ Instalar Ansible"

          # Regenerar claves SSH (mismo par que en Terraform)
          - script: |
              ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
            displayName: "üîë Regenerar claves SSH"

          # Generar inventario din√°mico
          - script: |
              echo "üìù Generando inventario Ansible..."
              echo "[webservers]" > inventory.ini
              echo "$(vmIP) ansible_user=azureuser ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_ssh_common_args='-o StrictHostKeyChecking=no'" >> inventory.ini

              echo "Inventario generado:"
              cat inventory.ini
            displayName: "üìã Crear inventario"

          # Esperar a que SSH est√© disponible
          - script: |
              echo "‚è≥ Esperando a que SSH est√© disponible..."
              MAX_RETRIES=20
              RETRY_COUNT=0

              while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                echo "Intento $((RETRY_COUNT + 1))/$MAX_RETRIES..."
                if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa azureuser@$(vmIP) "echo 'SSH OK'" 2>/dev/null; then
                  echo "‚úÖ SSH disponible!"
                  break
                fi
                RETRY_COUNT=$((RETRY_COUNT + 1))
                [ $RETRY_COUNT -lt $MAX_RETRIES ] && sleep 15
              done

              if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                echo "‚ùå ERROR: No se pudo conectar por SSH"
                exit 1
              fi
            displayName: "üîå Esperar conexi√≥n SSH"

          # Ejecutar Ansible Playbook
          - script: |
              echo "üé≠ Ejecutando Ansible playbook..."
              ansible-playbook -i inventory.ini setup_vm.yml -v
            displayName: "üéØ Ansible Playbook"

          # Verificar resultado
          - script: |
              echo "üåê Verificando deployment..."
              echo "Puedes acceder a: http://$(vmIP)"

              # Test HTTP
              sleep 5
              curl -s http://$(vmIP) | grep -q "Terraform + Ansible" && echo "‚úÖ Nginx OK" || echo "‚ö†Ô∏è Nginx podr√≠a no estar listo a√∫n"
            displayName: "‚úîÔ∏è Verificar deployment"
# ===================================================================
# NOTAS DE CONFIGURACI√ìN:
#
# 1. Crear variables secretas en Azure DevOps:
#    - azureServicePrincipalUsername (App ID)
#    - azureServicePrincipalPassword (Client Secret)
#    - azureTenant (Tenant ID)
#
# 2. Para crear Service Principal:
#    az ad sp create-for-rbac --name "terraform-ansible-demo" \
#      --role Contributor \
#      --scopes /subscriptions/{SUBSCRIPTION_ID}
#
# 3. Costo aproximado: Standard_B1s ‚âà $8-10/mes
#    Eliminar recursos: az group delete --name rg-terraform-ansible-demo --yes
# ===================================================================
